---
- name: Update ESPHome on LXC
  hosts: esphome
  become: true
  tasks:
    - name: Ensure dependency
      ansible.builtin.apt:
        name: python3-packaging
        state: latest # noqa: package-latest

    - name: Install setuptools in venv
      ansible.builtin.pip:
        name: setuptools
        state: latest # noqa: package-latest
        virtualenv: /opt/esphome/.venv

    - name: Get ESPHome version info
      community.general.python_requirements_info:
        dependencies:
          - esphome
      vars:
        ansible_python_interpreter: /opt/esphome/.venv/bin/python
      register: esphome_info

    # This helps you see the actual structure if it fails again
    - name: Debug ESPHome Info Structure
      ansible.builtin.debug:
        var: esphome_info
        verbosity: 1

    - name: Upgrade ESPHome Block
      when: esphome_info.mismatched | length > 0
      block:
        - name: Stop ESPHome Dashboard service
          ansible.builtin.systemd:
            name: esphomeDashboard.service
            state: stopped

        - name: Upgrade ESPHome via Pip
          ansible.builtin.pip:
            name: esphome
            state: latest # noqa: package-latest
            virtualenv: /opt/esphome/.venv

        - name: Start ESPHome Dashboard service
          ansible.builtin.systemd:
            name: esphomeDashboard.service
            state: started

    - name: Notify if up to date
      ansible.builtin.debug:
        # Using a safer way to get the version that doesn't crash if the key is missing
        msg: "ESPHome is already at latest version."
      when: esphome_info.mismatched | length == 0
